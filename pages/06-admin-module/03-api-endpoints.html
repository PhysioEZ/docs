<div class="breadcrumbs"> <a href="pages/introduction.html" class="nav-link">Docs</a> <span>/</span> <a
        href="pages/admin/01-overview.html" class="nav-link">Admin Module</a> <span>/</span> <span>User & Employee
        API</span> </div>

<section id="api-intro">
    <h1>Admin Module: User & Employee API</h1>
    <p> The Admin Module API provides all backend scripts for managing system access, employee records, and user
        credentials. These endpoints are called via JavaScript to perform create, read, update, and delete (CRUD)
        operations. </p>
    <p> This documentation is split into two sections, reflecting the system's evolution: </p>
    <ul>
        <li> <strong>Modern Employee API:</strong> The primary, consolidated system that operates on the
            <code>employees</code> table. This is the new standard for all employee and login management. </li>
        <li> <strong>Legacy User API:</strong> An older system that operates on a separate <code>users</code> table.
            This is being phased out but is documented here for completeness. </li>
    </ul>
</section>

<hr class="section-divider">

<section id="modern-api">
    <h2 id="modern-api-heading">Modern Employee API (<code>employees</code> table)</h2>
    <p> This is the primary, consolidated API for all employee management. It operates on the
        <strong><code>employees</code></strong> table and uses the
        <strong><code>$_SESSION['employee_id']</code></strong> and <strong><code>$_SESSION['role']</code></strong> for
        authentication. This API is used by <code>manage_users.php</code>. </p>

    <div class="api-endpoint">
        <h3 id="manage-user-actions">manage_user_actions.php</h3>
        <p>
            This is the main "controller" endpoint for all employee creation and updates. It's a single endpoint
            that expects a JSON payload with an <code>action</code> key to determine its behavior.
        </p>
        <ul>
            <li><strong>HTTP Method:</strong> <code>POST</code></li>
            <li><strong>Authentication:</strong>
                <ul>
                    <li>Requires <code>$_SESSION['employee_id']</code> to be set.</li>
                    <li>Requires <code>$_SESSION['role']</code> to be 'admin' or 'superadmin'.</li>
                </ul>
            </li>
            <li><strong>Request Format:</strong> Expects <code>application/json</code> raw body.</li>
        </ul>

        <hr class="subsection-divider">

        <h4>Action: <code>create_employee</code></h4>
        <p>Creates a new, complete employee record with personal details and login credentials.</p>
        <ul>
            <li><strong>JSON Payload Example:</strong>
                <pre><code class="language-json">

{ "action": "create_employee", "first_name": "Jane", "last_name": "Doe", "date_of_joining": "2025-01-15", "email": "jane.doe@clinic.com", "new_password": "aVerySecurePassword123", "confirm_password": "aVerySecurePassword123", "role_id": 3, "branch_id": 1, "phone_number": "9876543210", "address": "123 Clinic Ave", "is_active": 1 } </code></pre>
            </li>
            <li><strong>Validation & Core Logic:</strong>
                <ol>
                    <li>Validates that required fields (<code>first_name</code>, <code>last_name</code>,
                        <code>date_of_joining</code>, <code>email</code>, <code>new_password</code>,
                        <code>role_id</code>) are not empty. </li>
                    <li>Ensures <code>new_password</code> and <code>confirm_password</code> match.</li>
                    <li>Ensures <code>new_password</code> is at least 8 characters long.</li>
                    <li>Hashes the <code>new_password</code> using <code>password_hash()</code>.</li>
                    <li>Inserts the new record into the <code>employees</code> table.</li>
                    <li>Logs the action to <code>audit_log</code> via <code>log_activity()</code>, securely omitting the
                        password hash from the log.</li>
                </ol>
            </li>
            <li><strong>Error Responses:</strong>
                <ul>
                    <li><code>HTTP 400 Bad Request</code> if validation fails (e.g., "Passwords do not match.").</li>
                    <li><code>HTTP 500 Server Error</code> (with <code>message</code>) if the <code>email</code> is
                        already taken (PDOException 23000). </li>
                </ul>
            </li>
        </ul>

        <hr class="subsection-divider">

        <h4>Action: <code>update_employee</code></h4>
        <p>Updates an existing employee's personal details and/or login credentials. This action features
            intelligent validation for managing logins.</p>
        <ul>
            <li><strong>JSON Payload Example:</strong>
                <pre><code class="language-json">

{ "action": "update_employee", "employee_id": 102, "first_name": "Jane", "last_name": "Doe-Smith", "date_of_joining": "2024-01-01", "email": "jane.doe@clinic.com", "role_id": 2, "branch_id": 1, "is_active": 1, "phone_number": "9876543210", "address": "456 Main St", "new_password": null, "confirm_password": null } </code></pre>
            </li>
            <li><strong>Validation & Core Logic:</strong>
                <ol>
                    <li>Validates that <code>employee_id</code>, <code>first_name</code>, <code>last_name</code>, and
                        <code>date_of_joining</code> are present. </li>
                    <li><strong>Smart Validation 1:</strong> If <code>email</code> is set, <code>role_id</code>
                        <strong>must</strong> also be set (and vice-versa). Throws an error if you try to set one
                        without the other. </li>
                    <li><strong>Smart Validation 2:</strong> A <code>new_password</code> can only be set if
                        <code>email</code> and <code>role_id</code> are also present. </li>
                    <li><strong>Dynamic Query:</strong> Builds an <code>UPDATE</code> query based on all fields
                        provided.</li>
                    <li><strong>Remove Login:</strong> You can remove an employee's login access by passing
                        <code>"email": null</code> and <code>"role_id": null</code>. </li>
                    <li><strong>Password Change:</strong> If <code>new_password</code> is set, it's validated (match and
                        length), hashed, and included in the <code>UPDATE</code> query.</li>
                    <li>Logs the action to <code>audit_log</code>.</li>
                </ol>
            </li>
            <li><strong>Error Responses:</strong>
                <ul>
                    <li><code>HTTP 400 Bad Request</code> for invalid <code>employee_id</code> or missing fields. </li>
                    <li><code>HTTP 400 Bad Request</code> with message "To create or update a login, you must provide
                        BOTH an Email and a Role."</li>
                    <li><code>HTTP 500 Server Error</code> if the <code>email</code> is changed to one that is already
                        taken.</li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="api-endpoint">
        <h3 id="fetch-all-users">fetch_all_users.php</h3>
        <p>
            A read-only (<code>GET</code>) endpoint that fetches a list of all active employees, primarily for
            populating the admin chat list.
        </p>
        <ul>
            <li><strong>HTTP Method:</strong> <code>GET</code> (implied)</li>
            <li><strong>Authentication:</strong>
                <ul>
                    <li>Requires <code>$_SESSION['employee_id']</code> to be set.</li>
                    <li>Requires <code>$_SESSION['role']</code> to be 'admin' or 'superadmin'.</li>
                </ul>
            </li>
            <li><strong>Request Parameters:</strong> None.</li>
            <li><strong>Core Logic:</strong>
                <ol>
                    <li>Performs a <code>SELECT</code> on the <code>employees</code> table.</li>
                    <li><code>LEFT JOIN</code>s <code>roles</code> and <code>branches</code> to get their
                        human-readable names.</li>
                    <li>Filters for <code>e.is_active = 1</code>.</li>
                    <li><strong>Security Feature:</strong> Excludes the currently logged-in admin
                        (<code>e.employee_id != :current_employee_id</code>).</li>
                </ol>
            </li>
            <li><strong>Success Response:</strong> <code>HTTP 200 OK</code> with a JSON body:
                <pre><code class="language-json">

{ "success": true, "users": [ { "id": 102, "username": "Jane", "role": "doctor", "branch_name": "Main Clinic" } ] } </code></pre>
                <p><strong>Note:</strong> The response fields <code>id</code> and <code>username</code> are aliases for
                    <code>e.employee_id</code> and <code>e.first_name</code>, respectively, for frontend convenience.
                </p>
            </li>
            <li><strong>Error Response:</strong> <code>HTTP 403 Forbidden</code> if the session is invalid.
                <code>HTTP 500 Server Error</code> on database failure.</li>
        </ul>
    </div>

</section>

<hr class="section-divider">

<section id="legacy-api">
    <h2 id="legacy-api-heading">Legacy User API (<code>users</code> table)</h2>
    <p> These endpoints are part of an older, separate user management system. They operate on the
        <strong><code>users</code></strong> table (not <code>employees</code>) and use a different session key
        (<strong><code>$_SESSION['uid']</code></strong>). </p>
    <p> <strong>Note:</strong> This API is not compatible with the Modern Employee API. The functionality is superseded
        by <code>manage_user_actions.php</code>. </p>

    <div class="api-endpoint">
        <h3 id="create-user">create_user.php</h3>
        <ul>
            <li><strong>Purpose:</strong> Creates a new record in the <code>users</code> table.</li>
            <li><strong>HTTP Method:</strong> <code>POST</code></li>
            <li><strong>Authentication:</strong> 'admin' or 'superadmin' role in <code>$_SESSION['role']</code> and
                <code>$_SESSION['uid']</code> must be set.
            </li>
            <li><strong>Request Format:</strong> <code>application/json</code> raw body.</li>
            <li><strong>Core Logic:</strong>
                <ol>
                    <li>Validates <code>username</code>, <code>password</code> (min 8 chars), <code>role</code>,
                        and <code>is_active</code>.</li>
                    <li>Validates <code>role</code> against a strict list: ['reception', 'doctor', 'jrdoctor',
                        'admin'].</li>
                    <li>Hashes password and inserts into <code>users</code>.</li>
                    <li>Logs this action to <code>audit_log</code> using <code>log_activity()</code>.</li>
                </ol>
            </li>
            <li><strong>Error Response:</strong> <code>HTTP 400 Bad Request</code> for invalid input.
                <code>HTTP 500 Server Error</code> for duplicate <code>username</code> or <code>email</code>
                (PDOException 23000).
            </li>
        </ul>
    </div>

    <div class="api-endpoint">
        <h3 id="update-user">update_user.php</h3>
        <ul>
            <li><strong>Purpose:</strong> Updates an existing record in the <code>users</code> table.</li>
            <li><strong>HTTP Method:</strong> <code>POST</code></li>
            <li><strong>Authentication:</strong> 'admin' or 'superadmin' role in <code>$_SESSION['role']</code> and
                <code>$_SESSION['uid']</code> must be set.
            </li>
            <li><strong>Request Format:</strong> <code>application/json</code> raw body.</li>
            <li><strong>Core Logic:</strong>
                <ol>
                    <li>Validates <code>user_id</code>, <code>username</code>, <code>role</code>, and
                        <code>is_active</code>.
                    </li>
                    <li>Validates <code>role</code> against the same strict list (cannot create/edit
                        'superadmin').</li>
                    <li>Builds and executes an <code>UPDATE</code> query.</li>
                    <li><strong>Security Feature:</strong> The <code>WHERE</code> clause
                        (<code>WHERE id = :user_id AND role != 'superadmin'</code>) explicitly prevents this
                        endpoint from *ever* modifying a 'superadmin' account.</li>
                    <li>Logs the update to <code>audit_log</code>.</li>
                </ol>
            </li>
            <li><strong>Error Response:</strong> <code>HTTP 400 Bad Request</code> for invalid input.
                <code>HTTP 500 Server Error</code> for duplicate username/email.
                <code>HTTP 200 OK</code> with <code>"success": false</code> if no user was found to update.
            </li>
        </ul>
    </div>

    <div class="api-endpoint">
        <h3 id="change-user-password">change_user_password.php</h3>
        <ul>
            <li><strong>Purpose:</strong> Updates *only* the password for a user in the <code>users</code> table.
            </li>
            <li><strong>HTTP Method:</strong> <code>POST</code></li>
            <li><strong>Authentication:</strong> 'admin' or 'superadmin' role in <code>$_SESSION['role']</code> and
                <code>$_SESSION['uid']</code> must be set.
            </li>
            <li><strong>Request Format:</strong> <code>application/json</code> raw body.</li>
            <li><strong>Core Logic:</strong>
                <ol>
                    <li>Validates <code>user_id</code> and <code>new_password</code> (min 8 chars).</li>
                    <li>Hashes the new password.</li>
                    <li>Performs an <code>UPDATE</code> query.</li>
                    <li><strong>Security Feature:</strong> Like <code>update_user.php</code>, this query
                        <strong>cannot</strong> change the password of a 'superadmin'
                        (<code>WHERE id = :user_id AND role != 'superadmin'</code>).
                    </li>
                    <li>Logs the password change to <code>audit_log</code>.</li>
                </ol>
            </li>
            <li><strong>Error Response:</strong> <code>HTTP 400 Bad Request</code> for invalid input.
                <code>HTTP 200 OK</code> with <code>"success": false</code> if no user was found or the user was a
                superadmin.
            </li>
        </ul>
    </div>

</section>